sudo: false

language: c

os:
  - linux

env:
  global:
    - GH_REF: github.com/Fortran-FOSS-Programmers/FIAT
    - secure: j7Q7G2e3UmxA4jPAD+piur2/yFQr0jEJc1I0ec41fg5/1n9KeqXOSSJkyA8UAkb0qEHknliu6jK33qHB0fpGN5mKe2XvHfIURuV8Pd601fVYX9eXLnqpH8qGJxZFhLL5wTMyZodq1doIuXI3roBqMfjN6kEsHd1rY2xKw8C/xNnlcII8sGSBeXgeVqzeDKtCWKg3bUPqZnPhOcpsan+utbWEDj53YB4LdAvBi8KkVK8GjAixxn+8yKHn9yIeHtn+HaO2s3ihiQRKkqSpddtj23mLWg1eS33oqCUECvJSSs71pnSkLEHFNCZzJxc4L6SCO6d3n5WPqhod0uw2WvL3XQx/u5sSBVdVUof6Sna7wCf/27HXiZSEwFrcq6q3/eVu/kmqsY0AOsCDVQbGKGnopxP+cehLmxB0jgn2M/Aia969z+ZqKBK83wisyq70gmucNFpt9xwSGvCSh48+Lnw1Lkzm8CAB8brC70PKxqVQdXPSfeaZ4L2TuVbUPAb4rvKEVidxGiXALjkcMqvTG/RunelEMQDCwQZvqoh6BppTEkQ+oq6LKO6RV3yTMO9Ad2k1CwEvhtwaf438ZWtPOvuiY3NeBqcNDPbQ0AcALBO4RqQyTuekP91bPKgbVrChb27ehoSeGcJh+PkZ0s4Dm0pRx+8f8xVRE5uW8Gfs0YoEvYY=

addons:
  apt:
    sources:
      - ubuntu-toolchain-r-test
    packages:
      - gcc-5
      - gfortran-5
      - python-pip
      - python-virtualenv
      - graphviz

cache:
  apt: true
  pip: true
  directories:
    - $HOME/.cache/pip
    - $HOME/.local

install:
  - export LOCAL_BIN=$HOME/.local/bin
  - export PATH=$LOCAL_BIN:/usr/local/bin:/usr/bin:$PATH
  - if [ ! -d $HOME/venv ]; then virtualenv $HOME/venv; fi
  - if [ -e $LOCAL_BIN/gcov ]; then rm $LOCAL_BIN/gcov; fi
  - ln -s `which gcov-5` $LOCAL_BIN/gcov
  - if [ -e $LOCAL_BIN/gfortran ]; then rm $LOCAL_BIN/gfortran; fi
  - ln -s `which gfortran-5` $LOCAL_BIN/gfortran
#  - source $HOME/venv/bin/activate
  - pip install --user --upgrade graphviz
  - pip install --user --upgrade ford && ford --version
  - pip install --user --upgrade ghp-import
  - pip install --user --upgrade codecov
  - |
    if [ ! -d $HOME/pFUnit ]; then
      git clone git://git.code.sf.net/p/pfunit/code $HOME/pFUnit
      cd $HOME/pFUnit
    else
      cd $HOME/pFUnit
      git pull
    fi
  - export F90_VENDOR=GNU
  - export F90=gfortran-5
  - make tests
  - make install INSTALL_DIR=$LOCAL_BIN/pfunit-serial
  - export PFUNIT=$LOCAL_BIN/pfunit-serial
  - cd -

script:
  - make tests

after_success:
  - echo "SUCCESS! Once the project is further along I'll regenerate and push documentation"
  - make gcov
  - codecov -X gcov
  - ford doc.md
  - git config user.name "Travis CI"
  - git config user.email "cmacmackin@gmail.com"
  #- git pull origin gh-pages
  - ghp-import doc -m "Documentation regenerated by TravisCI, `date`"
  - git push --force --quiet "https://${GH_TOKEN}@${GH_REF}" gh-pages > /dev/null 2>&1

